function [] = t070203_comp

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    e = @(t) exp(-3*t.^2 -1);
    u     = @(x, t) -sin(2*x - 3).*cos(2*t + 3).*e(t);
    u_x   = @(x, t) -2*cos(2*t + 3).*cos(3 - 2*x).*e(t);
    u_xx  = @(x, t) -4*cos(2*t + 3).*sin(3 - 2*x).*e(t);
    u_t   = @(x, t) -2*sin(3 - 2*x).*( sin(2*t+3) + 3*t.*cos(2*t+3) ) .* e(t);
    u_xt  = @(x, t)  4*cos(3 - 2*x).*(sin(2*t +3) + 3*t.*cos(2*t+3)) .* e(t);
    f     = @(x, t) u_t(x, t) - 9*u_xx(x, t);

    w     = @(x, t) (-(x - 1).^2 / 2) .* u_x(0, t)  + (x.^2 / x ) .* u_x(1, t);
    w_t   = @(x, t) (-(x - 1).^2 / 2) .* u_xt(0, t)  + (x.^2 / x ) .* u_xt(1, t);
    w_xx  = @(x, t) u_x(1, t) - u_x(0, t);
    g     = @(x, t) 9*w_xx(x, t) + f(x, t) - w_t(x, t);

    % Конечно можно вести себя так, какбудто мы не знаем u, тогда надо задать u(x, 0).
    % Но я не вижу в этом большого смысла.
    v = @(x, t) u(x, t) - w(x, t);

    lambda = @(k) (pi * k).^2;
    lambdasqrt = @(k) pi * k;
    Xkf = @(k, x) (k ~= 0) * cos(lambdasqrt(k)*x);
    XK_NORM_SQ = @(k) (k == 0)*1 + (k ~= 0) * 0.5;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    T_MIN = 0;
    T_MAX = 1.5;

    X_MIN = 0;
    X_MAX = 1;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    K = 5;
    T = T_MIN:0.1:T_MAX;
    X = X_MIN:0.01:X_MAX;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    TRAPZ_STEP = 0.0001;
    TRAPZ_GRID_X = X_MIN:TRAPZ_STEP:X_MAX;
    XK_TRAPZ = zeros(K+1, length(TRAPZ_GRID_X));
    VTZERO = v(TRAPZ_GRID_X, 0);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    UA = zeros(length(T), length(X));
    XK = zeros(K+1, length(X));
    TK = zeros(length(T), K+1);
    UN = zeros(length(T), length(X));

    ABS_ERR = zeros(length(T), length(X));
    REL_ERR = zeros(length(T), length(X));

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    for k = 1:K
        XK_TRAPZ(k+1, :) = Xkf(k, TRAPZ_GRID_X);
        XK(k+1, :) = Xkf(k, X);
    end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    xik = @(k) trapz(TRAPZ_GRID_X, VTZERO .* XK_TRAPZ(k+1, :)) / XK_NORM_SQ(k);

    function [ y ] = gk(k, t)
        y = zeros(length(t));
        for n = 1:length(t)
            y(n) = trapz(TRAPZ_GRID_X, g(TRAPZ_GRID_X, t(n)) .* XK_TRAPZ(k+1, :)) / XK_NORM_SQ(k);
        end
    end

    function [ y ] = Tkf(k, t)
        [odet Tk ] = ode45(@(u, v)  -9*lambda(k)*v(1) + gk(k, u), [ T_MIN T_MAX ], [ xik(k) ]);
        y = interp1(odet, Tk, t);
    end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    for k = 1:K
        TK(:, k+1) = Tkf(k, T);
    end

    V = TK * XK;

    for i = 1:length(T)
        for j = 1:length(X)
            UN(i, j) = w(X(j), T(i)) + V(i, j);
            UA(i, j) = u(X(j), T(i));

            ABS_ERR(i, j) = abs(UN(i, j) - UA(i, j));
            REL_ERR(i, j) = abs(ABS_ERR(i, j) / UA(i, j));
        end
    end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

    save('solution.mat', 'UA', 'UN', 'X', 'T', 'ABS_ERR', 'REL_ERR');
end
